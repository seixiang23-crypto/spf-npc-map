<!DOCTYPE html>
<html>
<head>
  <title>SPF NPC Boundary (Live)</title>

  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDE5t8KUNO1hc73bhetGBi1rXghs-lgG3U"></script>
</head>
<body>

<div id="map"></div>

<script>
  const datasetId = "d_89b44df21fccc4f51390eaff16aa1fe8";

  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 1.3521, lng: 103.8198 },
    zoom: 11
  });

  async function loadNPC() {
    try {
      // STEP 1: Ask data.gov.sg for download link
      const pollUrl =
        `https://api-open.data.gov.sg/v1/public/api/datasets/${datasetId}/poll-download`;

      let response = await fetch(pollUrl);
      let pollData = await response.json();

      if (pollData.code !== 0) {
        throw new Error(pollData.errMsg);
      }

      // STEP 2: Get the real GeoJSON file
      const geojsonUrl = pollData.data.url;
      response = await fetch(geojsonUrl);
      const geojson = await response.json();

      // STEP 3: Draw on map
      map.data.addGeoJson(geojson);

      map.data.setStyle({
        fillColor: "#1976D2",
        fillOpacity: 0.3,
        strokeColor: "#0D47A1",
        strokeWeight: 1
      });

      const info = new google.maps.InfoWindow();
      map.data.addListener("click", e => {
        info.setContent(`
          <b>${e.feature.getProperty("NPC_NAME")}</b><br>
          Division: ${e.feature.getProperty("DIV")}
        `);
        info.setPosition(e.latLng);
        info.open(map);
      });

    } catch (err) {
      console.error(err);
      alert("Failed to load NPC data");
    }
  }

  loadNPC();
</script>

</body>
</html>
